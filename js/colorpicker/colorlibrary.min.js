'use strict';$msRoot.createNS("ColorPicker.ColorLibrary");
$msRoot.ColorPicker.ColorLibrary=function(y){function f(b){m.push(this);this.id="ms-colorLibrary-"+u++ +"-";this.library;this.selectedColor;this.colorSwatches=[];this.currentColor;this.color;this.container;this.col;this.colorLibInner;this.libraryNameCombo;this.colorNameCombo;this.colorLibInner;this.settings=$ms.cloneSettings(v,b);this.table="__colorlib-"+this.settings.libSuffix;this.openDialogs=[];this.onLoadFn=this.onLoad.bind(this)}function w(){for(var b=[],c=255;0<=c;){var a="rgb("+c+","+c+","+
c+")",d=$msRoot.colorMethods.colorNameInfo(a,"name");d||=a;b.push({name:d,rgbString:a,hex:$msRoot.colorMethods.rgbToHex(a)});c=255==c?c-31:c-32}return b}var m=[],u=0,v={fontSize:75,cbSetColor:void 0,saveLabel:"Save",valueToSet:"rgbString",libSuffix:"",cbResize:void 0};f.getInstance=function(b){if("undefined"!==typeof b)for(var c=0;c<m.length;c++){if(m[c].id==b)return m[c]}else return m};f.prototype.onLoad=function(){var b=new $msRoot.LocalData;$ms.removeOnLoad(this.container,this.onLoadFn);b.getProperty("colorlibrary-"+
this.settings.valueToSet,"open")&&(this.modeOpen(!1),this.settings.cbResize&&this.settings.cbResize("open"))};f.prototype.createForm=function(){var b=new $msRoot.LocalData;b.getProperty("colorlibrary-"+this.settings.valueToSet,"open");this.container=document.createElement("div");this.container.id=this.id+"container";this.container.className="ms-cp-lib-container";this.container.style.fontSize=$ms.targetFontSize(this.settings.fontSize);$ms.setOnLoad(this.container,this.onLoadFn);this.colorLibHandle=
document.createElement("div");this.colorLibHandle.className="ms-cp-lib-handle";this.colorLibHandle.title="Click the vertical bar to expand and contract the library.";this.container.appendChild(this.colorLibHandle);var c=document.createElement("div");c.className="ms-cp-lib-handle-image";this.colorLibHandle.appendChild(c);this.colorLibHandle.addEventListener("click",function(){if(150<parseInt(getComputedStyle(this.container).getPropertyValue("width"))){var d="close";this.modeClose();b.setProperty("colorlibrary-"+
this.settings.valueToSet,"open",!1)}else d="open",this.modeOpen(!0),b.setProperty("colorlibrary-"+this.settings.valueToSet,"open",!0);this.settings.cbResize&&this.settings.cbResize(d)}.bind(this));this.colorLibInner=document.createElement("div");this.colorLibInner.id=this.id+"color-lib-inner";this.colorLibInner.className="ms-cp-lib-inner";this.container.appendChild(this.colorLibInner);c=document.createElement("div");c.lineHeight="18px";this.container.appendChild(c);var a=document.createElement("div");
a.innerHTML="Name";a.className="ms-gradient-label";a.style.width="40px";c.appendChild(a);a=[];this.colorNameCombo=$ms.createEditableCombo(a,{inputId:this.id+"color-name-input",containerId:this.id+"color-name-container",width:"85px",maxHeight:"300",cbChange:this.loadColor.bind(this),observeSizeChanges:!0,listenWindowClick:!0});this.colorNameCombo.container.style.verticalAlign="text-top";this.colorNameCombo.container.style.display="inline-block";c.appendChild(this.colorNameCombo.container);a=document.createElement("div");
a.id=this.id+"delete-color-button";a.innerHTML="Delete";a.className="ms-gradient-button ms-cp-button display-none";a.style.display="inline-block";a.style.margin="0 0 0 5px";a.style.lineHeight="14px";a.addEventListener("click",function(d){this.deleteColor()}.bind(this));c.appendChild(a);c=document.createElement("div");this.container.appendChild(c);a=document.createElement("div");a.innerHTML="Library";a.className="ms-gradient-label";a.style.width="40px";c.appendChild(a);a=this.loadLibraryNames();"rgbString"==
this.settings.valueToSet&&a.splice(0,0,{name:"Color Names",type:"readonly"},{name:"Gray Colors",type:"readonly"});this.libraryNameCombo=$ms.createEditableCombo(a,{inputId:this.id+"library-name-input",containerId:this.id+"library-name-container",width:"85px",cbChange:this.loadLibrary.bind(this),observeSizeChanges:!0,listenWindowClick:!0});this.libraryNameCombo.container.style.verticalAlign="text-top";this.libraryNameCombo.container.style.display="inline-block";c.appendChild(this.libraryNameCombo.container);
a=document.createElement("div");a.id=this.id+"delete-library-button";a.innerHTML="Delete";a.className="ms-gradient-button ms-cp-button display-none";a.style.display="inline-block";a.style.margin="0 0 0 5px";a.style.verticalAlign="bottom";a.style.lineHeight="14px";a.addEventListener("click",function(){this.library&&this.deleteLibrary(this.library)}.bind(this));c.appendChild(a);a=document.createElement("div");a.id=this.id+"save-color-button";a.innerHTML=this.settings.saveLabel;a.className="ms-gradient-button ms-cp-button";
a.style.display="inline-block";a.style.marginRight="5px";a.addEventListener("click",function(d){this.saveColor()}.bind(this));this.container.appendChild(a);a=document.createElement("div");a.id=this.id+"export-button";a.innerHTML="Export";a.className="ms-gradient-button ms-cp-button";a.style.display="inline-block";a.title="Export all libraries and colors to a file";a.style.marginRight="5px";a.addEventListener("click",function(){this.exportLib()}.bind(this));this.container.appendChild(a);a=document.createElement("div");
a.id=this.id+"import-button";a.innerHTML="Import";a.className="ms-gradient-button ms-cp-button display-none";a.style.display="inline-block";a.title="Import and replace all libraries and colors from an exported file";a.addEventListener("click",function(d){this.importLib(d)}.bind(this));this.container.appendChild(a);return this.container};f.prototype.modeOpen=function(b){var c=b?250:0;b?($ms.addClass(this.container,"ms-cp-lib-container-animate-open"),$ms.removeClass(this.container,"ms-cp-lib-container-animate-close"),
$ms.removeClass(this.container,"ms-cp-lib-container-open")):($ms.removeClass(this.container,"ms-cp-lib-container-animate-open"),$ms.removeClass(this.container,"ms-cp-lib-container-animate-close"),$ms.addClass(this.container,"ms-cp-lib-container-open"));setTimeout(function(){$ms.$(this.id+"library-name-container").style.width="135px";$ms.$(this.id+"color-name-container").style.width="135px";$ms.removeClass($ms.$(this.id+"delete-color-button"),"display-none");$ms.removeClass($ms.$(this.id+"delete-library-button"),
"display-none");$ms.removeClass($ms.$(this.id+"import-button"),"display-none");this.selectedColor&&$ms.scrollIntoView(this.selectedColor.div)}.bind(this),c)};f.prototype.modeClose=function(){$ms.$(this.id+"color-name-input").style.width="85px";$ms.addClass($ms.$(this.id+"delete-color-button"),"display-none");$ms.addClass($ms.$(this.id+"delete-library-button"),"display-none");$ms.addClass($ms.$(this.id+"import-button"),"display-none");$ms.$(this.id+"library-name-container").style.width="85px";$ms.$(this.id+
"color-name-container").style.width="85px";$ms.addClass(this.container,"ms-cp-lib-container-animate-close");$ms.removeClass(this.container,"ms-cp-lib-container-animate-open");$ms.removeClass(this.container,"ms-cp-lib-container-open");setTimeout(function(){this.selectedColor&&$ms.scrollIntoView(this.selectedColor.div)}.bind(this),250)};f.prototype.loadLibraryNames=function(){var b=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"}),c=[],a=b.getRecords(this.table);if(Array.isArray(a))for(var d=
0;d<a.length;d++)c.push({name:a[d].id,type:"user"});c||=[];a=!1;for(d=0;d<c.length;d++)if("Default"==c[d].name){a=!0;break}a||(c.splice(0,0,{name:"Default",type:"user"}),b.set(this.table,"Default",{name:"Default",type:"user",records:[],version:b.version}));return c};f.prototype.loadLibrary=function(b){if("Color Names"==b.value){var c=$msRoot.colorMethods.colorNameInfo();this.library={name:"Color Names",type:"readonly",records:c.map(function(d,e){var g=$msRoot.colorMethods.hexToRgb(d.hex,1,!0);g=$msRoot.colorMethods.rgbToHsv({r:g.r,
g:g.g,b:g.b});return{color:[g.h,g.s,g.v,d.name],index:e}}).sort(function(d,e){if(d.color[0]<e.color[0])return-1;if(d.color[0]>e.color[0])return 1;if(d.color[1]<e.color[1])return-1;if(d.color[1]>e.color[1])return 1;if(d.color[2]<e.color[2])return-1;if(d.color[2]>e.color[2])return 1}).map(function(d){return c[d.index]})}}else if("Gray Colors"==b.value)this.library={name:"Gray",type:"readonly",records:w("name list")};else{var a=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});
this.library=a.get(this.table,b.value);if(!this.library)return"Default"==b.value?(this.library={name:"Default",type:"user",records:[],version:a.version},a.set(this.table,"Default",this.library),!0):!1}this.showLibrary(this.library);this.loadColorNames();return!0};f.prototype.loadColorNames=function(){var b=this.libraryColorNames();this.colorNameCombo.createOptions(b,!0)};f.prototype.showLibrary=function(b){this.reset();for(var c=0;c<b.records.length;c++)this.createColorSwatch(b.records[c]);"readonly"==
b.type?($ms.addClass($ms.$(this.id+"delete-color-button"),"ms-disabled"),$ms.addClass($ms.$(this.id+"delete-library-button"),"ms-disabled"),$ms.addClass($ms.$(this.id+"save-color-button"),"ms-disabled")):($ms.removeClass($ms.$(this.id+"delete-color-button"),"ms-disabled"),$ms.removeClass($ms.$(this.id+"delete-library-button"),"ms-disabled"),$ms.removeClass($ms.$(this.id+"save-color-button"),"ms-disabled"))};f.prototype.createColorSwatch=function(b){var c=document.createElement("div");c.className=
"ms-cp-lib-color-div ms-cp-transparent-grid";$ms.$(this.id+"color-lib-inner").appendChild(c);var a=document.createElement("div"),d=b.name.replace(/[^A-Za-z0-9-_:.]/g,"-"),e=encodeURIComponent(b.name);a.id=this.id+d;a.className="ms-cp-lib-color-swatch";a.setAttribute("data-name",e);"gradient"==this.settings.valueToSet?a.style.background=b.gradient:a.style.backgroundColor=b.rgbString;a.title=b.name;(function(g){a.addEventListener("click",function(){this.selectColor(b,g,!0)}.bind(this))}).call(this,
a);c.appendChild(a);this.colorSwatches.push(a);return a};f.prototype.deleteLibrary=function(b){"readonly"!=this.library.type&&confirm("Are you ABSOLUTELY sure you want to delete the library "+b.name+" and all its swatches?")&&((new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"})).del(this.table,b.name),this.reset(),this.libraryNameCombo.deleteOption(b.name),this.libraryNameCombo.setValue("Default"),this.colorNameCombo.setValue(""))};f.prototype.selectColor=function(b,
c,a){b.div=c;a&&this.settings.cbSetColor(b);this.selectedColor=b;this.colorNameCombo.setValue(b.name);for(b=0;b<this.colorSwatches.length;b++)$ms.removeClass(this.colorSwatches[b],"ms-cp-lib-color-selected"),$ms.removeClass(this.colorSwatches[b],"ms-cp-lib-color-highlighted");a?$ms.addClass(c,"ms-cp-lib-color-selected"):$ms.addClass(c,"ms-cp-lib-color-highlighted");$ms.scrollIntoView(c)};f.prototype.saveColor=function(b,c){var a=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});
"undefined"==typeof b&&(b=this.colorNameCombo.value.trim());if(!this.library||!this.library.name){var d=this.libraryNameCombo.value.trim();""==d?(this.libraryNameCombo.setValue("Default"),this.libraryNameCombo.settings.cbChange({value:"Default"},"select")):this.loadLibrary({value:d})||(this.library={name:d,type:"user",records:[],version:a.version},a.set(this.table,d,this.library),this.libraryNameCombo.addOption({label:d,value:d}),this.reset())}if(d=a.getChild(this.table,this.library.name,b))a=["'"+
b+"' already exists. Do you wish to overwrite it or add a new one?"],c&&a.push("<span style='color:red'>Enter a NEW name to 'Add New'</span>"),b={id:this.id,dialogTitle:"Confirm Overwrite",text:a,buttons:[{label:"Overwrite",title:"Overwrites the selected ",cb:function(e){this.doSave("overwrite",e)}.bind(this)},{label:"Add New",title:"Add a new ",cb:function(e){this.doSave("add",e)}.bind(this)},{label:"Cancel"}],input:{label:"Enter a name: ",value:b}},new $msRoot.CustomDialog(b);else{if(0==b.length)for(c=
a.nextId(this.table);1E3>c;){b="gradient"==this.settings.valueToSet?"Gradient "+c:"Color "+c;d=a.getChild(this.table,this.library.name,b);if(!d){this.colorNameCombo.setValue(b);break}c++}this.doSave("add",b)}};f.prototype.doSave=function(b,c){var a=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});"object"==typeof c&&(c=c.settings.input.element.value);var d=a.getChild(this.table,this.library.name,c);if(d&&"overwrite"!==b)this.saveColor(c,!0);else{this.color.name=c;
a.setChild(this.table,this.library.name,c,this.color);if(d)for(b=0;b<this.library.records.length;b++){if(this.library.records[b].name==c){for(var e in this.color)this.color.hasOwnProperty(e)&&(this.library.records[b][e]=this.color[e]);"gradient"==this.settings.valueToSet?this.colorSwatches[b].style.background=this.color.gradient:this.colorSwatches[b].style.backgroundColor=this.color.rgbString;break}}else this.colorNameCombo.addOption(c),c=Object.assign({},this.color),this.library.records.push(c),
c=this.createColorSwatch(c),this.selectColor(this.color,c,!1);$ms.scrollIntoView(this.selectedColor.div);this.colorNameCombo.setValue("")}};f.prototype.deleteColor=function(){this.selectedColor&&"readonly"!=this.library.type&&((new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"})).deleteChild(this.table,this.library.name,this.selectedColor.name),this.selectedColor.div.parentNode.parentNode.removeChild(this.selectedColor.div.parentNode),this.colorDeselect())};f.prototype.exportLib=
function(){var b=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"}),c=b.getRecords(this.table);if(c&&Array.isArray(c)){b=b.getProperty(this.table,"nextId");c.push({nextId:b,type:this.settings.valueToSet});b=new Date;var a=function(d,e,g){d=""+d;g-=d.length;if(1>g)return d;e=""+e;for(var k=[],l=0;l<g;)k[l++]=e;return k.join("")+d};b=b.getFullYear()+"-"+a(b.getMonth()+1,"0",2)+"-"+a(b.getDate(),"0",2)+"-"+a(b.getHours(),"0",2)+"-"+a(b.getMinutes(),"0",2)+"-"+a(b.getSeconds(),
"0",2);b=new $msRoot.LocalFile(("gradient"==this.settings.valueToSet?"gradient-libraries-":"color-libraries-")+b+".txt");b.text=JSON.stringify(c);b.saveFile()}else console.log("No libraries found")};f.prototype.importLib=function(b){b=document.createElement("input");b.id=this.id+"file-input";b.type="file";b.style.opacity="0";var c=new $msRoot.LocalFile;c.cbOnFileLoad=this.cbImportFile.bind(this);b.addEventListener("change",c.loadFile.bind(c),!1);document.body.appendChild(b);b.click()};f.prototype.cbImportFile=
function(b){var c="gradient"==this.settings.valueToSet?"Gradient":"Color",a=JSON.parse(b);b="";if("object"!==typeof a)alert("Invalid file format (1)");else if(Array.isArray(a)){for(var d=[],e=0;e<a.length;e++){if("object"!==typeof a[e]){alert("Invalid file format (3)");return}if(a[e].nextId)b=a[e].type,d.push("nextId ==> "+a[e].nextId),d.push("type ==> "+a[e].type);else{if(!a[e].value){alert("Invalid file format (5)");return}if(!a[e].value.records){alert("Invalid file format (6)");return}d.push("**** Library Name: "+
a[e].id+" ****");if(0==a[e].value.records.length)d.push("Empty Library");else for(var g=0;g<a[e].value.records.length;g++){var k=a[e].value.records[g]["gradient"==this.settings.valueToSet?"gradient":"rgbString"];k=a[e].value.records[g].name+" => "+k.substr(0,50)+(50<k.length?"...":"");d.push(c+": "+k)}}}b!==this.settings.valueToSet?alert("Only libraries of type: "+c+" may be imported."):(c={id:this.id,dialogTitle:"Confirm Import",text:["","The following libraries and "+c+"s will be imported:",""].concat(d).concat([""]),
position:"fixed",textAlign:"left",buttonClass:"ms-gradient-button",buttonsOnTop:!0,buttons:[{label:"Delete Existing",title:"Delete all existing libraries and "+c+"s before import.",cb:function(){this.doImport(a,"delete")}.bind(this)},{label:"Overwrite Duplicates",title:"Keep existing libraries and "+c+"s and overwrite duplicates from the import.",cb:function(){this.doImport(a,"overwrite")}.bind(this)},{label:"Discard Duplicates",title:"Keep existing libraries and "+c+"s and dicard duplicates from the import.",
cb:function(){this.doImport(a,"discard")}.bind(this)},{label:"Cancel",title:"Cancel the import."}]},new $msRoot.CustomDialog(c))}else alert("Invalid file format (2)")};f.prototype.doImport=function(b,c){var a,d="gradient"==this.settings.valueToSet?"Gradient":"Color",e=["Import Status"],g=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"}),k,l,n=0;"delete"==c?g.zap(this.table):n=g.getProperty(this.table,"nextId");for(var h=0;h<b.length;h++){var r=l=k=0;if(b[h].nextId)n=
Math.max(n,b[h].nextId),g.setProperty(this.table,"nextId",n),e.push("Set nextId: "+n);else if("delete"!==c&&(a=g.get(this.table,b[h].id)),"delete"!=c&&a&&a.records&&0!=a.records.length){for(var p=0;p<b[h].value.records.length;p++){for(var x=b[h].value.records[p].name,t=!1,q=0;q<a.records.length;q++)if(x==a.records[q].name){t=!0;"discard"==c?r++:(k++,a.records[q]=b[h].value.records[p]);break}t||(l++,a.records.push(b[h].value.records[p]))}g.set(this.table,b[h].id,a);e.push("Library: "+b[h].id+" => Added: "+
l+" Replaced: "+k+" Discarded: "+r)}else e.push("Library: "+b[h].id+" => Imported whole library - "+b[h].value.records.length+" "+d+" records."),g.set(this.table,b[h].id,b[h].value)}console.log(e.join("\n"));b=!1;c="";this.library&&(c=this.library.name);this.reset();0<c.length&&(b=this.loadLibrary({value:c}));b||this.loadLibrary({value:"Default"})};f.prototype.colorDeselect=function(){this.selectedColor=void 0;this.colorNameCombo.setValue("")};f.prototype.loadColor=function(b,c){for(var a,d=0;d<this.colorSwatches.length;d++)if(a=
decodeURIComponent(this.colorSwatches[d].getAttribute("data-name")),a.toLowerCase()==b.value.toLowerCase()){b="gradient"==this.settings.valueToSet?$msRoot.colorMethods.colorInfo(this.colorSwatches[d].style.background):$msRoot.colorMethods.colorInfo(this.colorSwatches[d].style.backgroundColor);b.name=a;this.selectColor(b,this.colorSwatches[d],c);break}};f.prototype.libraryColorNames=function(){var b=[];if(this.library){for(var c=0;c<this.library.records.length;c++)b.push(this.library.records[c].name);
return b}};f.prototype.reset=function(){for(;this.colorLibInner.firstChild;)this.colorLibInner.removeChild(this.colorLibInner.firstChild);this.colorSwatches=[]};f.prototype.close=function(){$msRoot.CustomDialog.closeDialogs(this.id);this.libraryNameCombo.close();this.colorNameCombo.close()};return f}();
