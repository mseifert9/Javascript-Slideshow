
$msRoot.createNS("ColorPicker.ColorLibrary");$msRoot.ColorPicker.ColorLibrary=(function(d){var a=[];var c=0;var b={fontSize:75,cbSetColor:undefined,saveLabel:"Save",valueToSet:"rgbString",libSuffix:"",cbResize:undefined};f.getInstance=function(h){if(typeof h!=="undefined"){for(var g=0;g<a.length;g++){if(a[g].id==h){return a[g]}}}else{return a}};function f(g){a.push(this);this.id="ms-colorLibrary-"+c+++"-";this.library;this.selectedColor;this.colorSwatches=[];this.currentColor;this.color;this.container;this.col;this.colorLibInner;this.libraryNameCombo;this.colorNameCombo;this.colorLibInner;this.settings=$ms.cloneSettings(b,g);this.table="__colorlib-"+this.settings.libSuffix;this.openDialogs=[];this.onLoadFn=this.onLoad.bind(this);this.ie9OrBelow=$ms.ie9OrBelow()}f.prototype.onLoad=function(){var h=new $msRoot.LocalData();$ms.removeOnLoad(this.container,this.onLoadFn);var g=h.getProperty("colorlibrary-"+this.settings.valueToSet,"open");if(g){this.modeOpen(false);if(this.settings.cbResize){this.settings.cbResize("open")}}};f.prototype.createForm=function(){var k=new $msRoot.LocalData();var g=k.getProperty("colorlibrary-"+this.settings.valueToSet,"open");this.container=document.createElement("div");this.container.id=this.id+"container";this.container.className="ms-cp-lib-container";this.container.style.fontSize=$ms.targetFontSize(this.settings.fontSize);$ms.setOnLoad(this.container,this.onLoadFn);this.colorLibHandle=document.createElement("div");this.colorLibHandle.className="ms-cp-lib-handle";this.colorLibHandle.title="Click the vertical bar to expand and contract the library.";this.container.appendChild(this.colorLibHandle);var m=document.createElement("div");m.className="ms-cp-lib-handle-image";this.colorLibHandle.appendChild(m);this.colorLibHandle.addEventListener("click",function(){if(parseInt(getComputedStyle(this.container).getPropertyValue("width"))>150){var n="close";this.modeClose();k.setProperty("colorlibrary-"+this.settings.valueToSet,"open",false)}else{var n="open";this.modeOpen(true);k.setProperty("colorlibrary-"+this.settings.valueToSet,"open",true)}if(this.settings.cbResize){this.settings.cbResize(n)}}.bind(this));this.colorLibInner=document.createElement("div");this.colorLibInner.id=this.id+"color-lib-inner";this.colorLibInner.className="ms-cp-lib-inner";this.container.appendChild(this.colorLibInner);var j=document.createElement("div");j.lineHeight="18px";this.container.appendChild(j);var l=document.createElement("div");l.innerHTML="Name";l.className="ms-gradient-label";l.style.width="40px";j.appendChild(l);var h=[];this.colorNameCombo=$ms.createEditableCombo(h,{inputId:this.id+"color-name-input",containerId:this.id+"color-name-container",width:"85px",maxHeight:"300",cbChange:this.loadColor.bind(this),observeSizeChanges:true,listenWindowClick:true});this.colorNameCombo.container.style.verticalAlign="text-top";this.colorNameCombo.container.style.display="inline-block";j.appendChild(this.colorNameCombo.container);var i=document.createElement("div");i.id=this.id+"delete-color-button";i.innerHTML="Delete";i.className="ms-gradient-button ms-cp-button display-none";i.style.display="inline-block";i.style.margin="0 0 0 5px";i.style.lineHeight="14px";i.addEventListener("click",function(n){this.deleteColor()}.bind(this));j.appendChild(i);var j=document.createElement("div");this.container.appendChild(j);l=document.createElement("div");l.innerHTML="Library";l.className="ms-gradient-label";l.style.width="40px";j.appendChild(l);var h=this.loadLibraryNames();if(this.settings.valueToSet=="rgbString"){h.splice(0,0,{name:"Color Names",type:"readonly"},{name:"Gray Colors",type:"readonly"})}this.libraryNameCombo=$ms.createEditableCombo(h,{inputId:this.id+"library-name-input",containerId:this.id+"library-name-container",width:"85px",cbChange:this.loadLibrary.bind(this),observeSizeChanges:true,listenWindowClick:true});this.libraryNameCombo.container.style.verticalAlign="text-top";this.libraryNameCombo.container.style.display="inline-block";j.appendChild(this.libraryNameCombo.container);var i=document.createElement("div");i.id=this.id+"delete-library-button";i.innerHTML="Delete";i.className="ms-gradient-button ms-cp-button display-none";i.style.display="inline-block";i.style.margin="0 0 0 5px";i.style.verticalAlign="bottom";i.style.lineHeight="14px";i.addEventListener("click",function(){if(!this.library){return}this.deleteLibrary(this.library)}.bind(this));j.appendChild(i);var i=document.createElement("div");i.id=this.id+"save-color-button";i.innerHTML=this.settings.saveLabel;i.className="ms-gradient-button ms-cp-button";i.style.display="inline-block";i.style.marginRight="5px";i.addEventListener("click",function(n){this.saveColor()}.bind(this));this.container.appendChild(i);var i=document.createElement("div");i.id=this.id+"export-button";i.innerHTML="Export";i.className="ms-gradient-button ms-cp-button";i.style.display="inline-block";i.title="Export all libraries and colors to a file";i.style.marginRight="5px";i.addEventListener("click",function(){this.exportLib()}.bind(this));this.container.appendChild(i);var i=document.createElement("div");i.id=this.id+"import-button";i.innerHTML="Import";i.className="ms-gradient-button ms-cp-button display-none";i.style.display="inline-block";i.title="Import and replace all libraries and colors from an exported file";i.addEventListener("click",function(n){this.importLib(n)}.bind(this));this.container.appendChild(i);return this.container};f.prototype.modeOpen=function(g){var h=g?250:0;if(g){$ms.addClass(this.container,"ms-cp-lib-container-animate-open");$ms.removeClass(this.container,"ms-cp-lib-container-animate-close");$ms.removeClass(this.container,"ms-cp-lib-container-open")}else{$ms.removeClass(this.container,"ms-cp-lib-container-animate-open");$ms.removeClass(this.container,"ms-cp-lib-container-animate-close");$ms.addClass(this.container,"ms-cp-lib-container-open")}setTimeout(function(){$ms.$(this.id+"library-name-container").style.width="135px";$ms.$(this.id+"color-name-container").style.width="135px";$ms.removeClass($ms.$(this.id+"delete-color-button"),"display-none");$ms.removeClass($ms.$(this.id+"delete-library-button"),"display-none");$ms.removeClass($ms.$(this.id+"import-button"),"display-none");if(this.selectedColor){$ms.scrollIntoView(this.selectedColor.div)}}.bind(this),h)};f.prototype.modeClose=function(){$ms.$(this.id+"color-name-input").style.width="85px";$ms.addClass($ms.$(this.id+"delete-color-button"),"display-none");$ms.addClass($ms.$(this.id+"delete-library-button"),"display-none");$ms.addClass($ms.$(this.id+"import-button"),"display-none");$ms.$(this.id+"library-name-container").style.width="85px";$ms.$(this.id+"color-name-container").style.width="85px";$ms.addClass(this.container,"ms-cp-lib-container-animate-close");$ms.removeClass(this.container,"ms-cp-lib-container-animate-open");$ms.removeClass(this.container,"ms-cp-lib-container-open");setTimeout(function(){if(this.selectedColor){$ms.scrollIntoView(this.selectedColor.div)}}.bind(this),250)};f.prototype.loadLibraryNames=function(){var k=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});var l=[];var g=k.getRecords(this.table);if(Array.isArray(g)){for(var h=0;h<g.length;h++){l.push({name:g[h].id,type:"user"})}}if(!l){l=[]}var j=false;for(var h=0;h<l.length;h++){if(l[h].name=="Default"){j=true;break}}if(!j){l.splice(0,0,{name:"Default",type:"user"});k.set(this.table,"Default",{name:"Default",type:"user",records:[],version:k.version})}return l};f.prototype.loadLibrary=function(h){if(h.value=="Color Names"){var j=$msRoot.colorMethods.colorNameInfo();var g=j.map(function(o,m){var l=$msRoot.colorMethods.hexToRgb(o.hex,1,true);var n=$msRoot.colorMethods.rgbToHsv({r:l.r,g:l.g,b:l.b});var k=[n.h,n.s,n.v,o.name];return{color:k,index:m}}).sort(function(l,k){if(l.color[0]<k.color[0]){return -1}if(l.color[0]>k.color[0]){return 1}if(l.color[1]<k.color[1]){return -1}if(l.color[1]>k.color[1]){return 1}if(l.color[2]<k.color[2]){return -1}if(l.color[2]>k.color[2]){return 1}}).map(function(k){return j[k.index]});this.library={name:"Color Names",type:"readonly",records:g}}else{if(h.value=="Gray Colors"){this.library={name:"Gray",type:"readonly",records:e("name list")}}else{var i=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});this.library=i.get(this.table,h.value);if(!this.library){if(h.value=="Default"){this.library={name:"Default",type:"user",records:[],version:i.version};i.set(this.table,"Default",this.library);return true}return false}}}this.showLibrary(this.library);this.loadColorNames();return true};f.prototype.loadColorNames=function(){var g=this.libraryColorNames();this.colorNameCombo.createOptions(g,true)};f.prototype.showLibrary=function(g){this.reset();for(var h=0;h<g.records.length;h++){this.createColorSwatch(g.records[h])}if(g.type=="readonly"){$ms.addClass($ms.$(this.id+"delete-color-button"),"ms-disabled");$ms.addClass($ms.$(this.id+"delete-library-button"),"ms-disabled");$ms.addClass($ms.$(this.id+"save-color-button"),"ms-disabled")}else{$ms.removeClass($ms.$(this.id+"delete-color-button"),"ms-disabled");$ms.removeClass($ms.$(this.id+"delete-library-button"),"ms-disabled");$ms.removeClass($ms.$(this.id+"save-color-button"),"ms-disabled")}};f.prototype.createColorSwatch=function(l){var i=document.createElement("div");i.className="ms-cp-lib-color-div ms-cp-transparent-grid";$ms.$(this.id+"color-lib-inner").appendChild(i);var k=document.createElement("div");var h=l.name.replace(/[^A-Za-z0-9-_:.]/g,"-");var n=encodeURIComponent(l.name);k.id=this.id+h;k.className="ms-cp-lib-color-swatch";k.setAttribute("data-name",n);if(this.settings.valueToSet=="gradient"){if(this.ie9OrBelow){var g=document.createElement("div");g.style.height="100%";g.style.width="100%";k.appendChild(g);var p=$msRoot.Gradient.getInstance();if(p.length>0){var m=p[0].getParsedGradient(l.gradient);var j=p[0].getGradientString(m[0]);k.style.filter=j.ie}}else{k.style.background=l.gradient}}else{k.style.backgroundColor=l.rgbString}k.title=l.name;var o=function(q){k.addEventListener("click",function(){this.selectColor(l,q,true)}.bind(this))}.bind(this);o(k);i.appendChild(k);this.colorSwatches.push(k);return k};f.prototype.deleteLibrary=function(g){if(this.library.type=="readonly"){return}if(!confirm("Are you ABSOLUTELY sure you want to delete the library "+g.name+" and all its swatches?")){return}var h=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});h.del(this.table,g.name);this.reset();this.libraryNameCombo.deleteOption(g.name);this.libraryNameCombo.setValue("Default");this.colorNameCombo.setValue("")};f.prototype.selectColor=function(g,k,j){g.div=k;if(j){this.settings.cbSetColor(g)}this.selectedColor=g;this.colorNameCombo.setValue(g.name);for(var h=0;h<this.colorSwatches.length;h++){$ms.removeClass(this.colorSwatches[h],"ms-cp-lib-color-selected");$ms.removeClass(this.colorSwatches[h],"ms-cp-lib-color-highlighted")}if(j){$ms.addClass(k,"ms-cp-lib-color-selected")}else{$ms.addClass(k,"ms-cp-lib-color-highlighted")}$ms.scrollIntoView(k)};f.prototype.saveColor=function(g,i){var m=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});if(typeof g=="undefined"){g=this.colorNameCombo.value.trim()}if(!this.library||!this.library.name){var j=this.libraryNameCombo.value.trim();if(j==""){this.libraryNameCombo.setValue("Default");this.libraryNameCombo.settings.cbChange({value:"Default"},"select")}else{if(!this.loadLibrary({value:j})){this.library={name:j,type:"user",records:[],version:m.version};m.set(this.table,j,this.library);this.libraryNameCombo.addOption({label:j,value:j});this.reset()}}}var p="";var l=false;var n=m.getChild(this.table,this.library.name,g);if(n){var q=["'"+g+"' already exists. Do you wish to overwrite it or add a new one?"];if(i){q.push("<span style='color:red'>Enter a NEW name to 'Add New'</span>")}var k={id:this.id,dialogTitle:"Confirm Overwrite",text:q,buttons:[{label:"Overwrite",title:"Overwrites the selected "+p,cb:function(r){this.doSave("overwrite",r)}.bind(this)},{label:"Add New",title:"Add a new "+p,cb:function(r){this.doSave("add",r)}.bind(this)},{label:"Cancel"}],input:{label:"Enter a name: ",value:g}};var o=new $msRoot.CustomDialog(k)}else{if(g.length==0){var h=m.nextId(this.table);while(h<1000){if(this.settings.valueToSet=="gradient"){g="Gradient "+h}else{g="Color "+h}var n=m.getChild(this.table,this.library.name,g);if(!n){this.colorNameCombo.setValue(g);break}h++}this.doSave("add",g)}else{this.doSave("add",g)}}};f.prototype.doSave=function(m,j){var l=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});if(typeof j=="object"){j=j.settings.input.element.value}var g=l.getChild(this.table,this.library.name,j);if(g&&m!=="overwrite"){this.saveColor(j,true);return}this.color.name=j;l.setChild(this.table,this.library.name,j,this.color);if(g){for(var k=0;k<this.library.records.length;k++){if(this.library.records[k].name==j){for(var o in this.color){if(!this.color.hasOwnProperty(o)){continue}this.library.records[k][o]=this.color[o]}if(this.settings.valueToSet=="gradient"){this.colorSwatches[k].style.background=this.color.gradient}else{this.colorSwatches[k].style.backgroundColor=this.color.rgbString}n=this.colorSwatches[k];break}}}else{this.colorNameCombo.addOption(j);var h=Object.assign({},this.color);this.library.records.push(h);var n=this.createColorSwatch(h);this.selectColor(this.color,n,false)}$ms.scrollIntoView(this.selectedColor.div);this.colorNameCombo.setValue("")};f.prototype.deleteColor=function(){if(!this.selectedColor){return}if(this.library.type=="readonly"){return}var g=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});g.deleteChild(this.table,this.library.name,this.selectedColor.name);this.selectedColor.div.parentNode.parentNode.removeChild(this.selectedColor.div.parentNode);this.colorDeselect()};f.prototype.exportLib=function(){var k=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});var l=k.getRecords(this.table);if(!l||!Array.isArray(l)){console.log("No libraries found");return}var i=k.getProperty(this.table,"nextId");l.push({nextId:i,type:this.settings.valueToSet});var n=new Date();var h=function(r,q){var s=[];for(var p=0;p<q;){s[p++]=r}return s.join("")};var j=function(p,s,r){p=""+p;s=""+s;var t=r-p.length;if(t<1){return p}var q=h(s,t);return q+p};var m=n.getFullYear()+"-"+j((n.getMonth()+1),"0",2)+"-"+j(n.getDate(),"0",2)+"-"+j(n.getHours(),"0",2)+"-"+j(n.getMinutes(),"0",2)+"-"+j(n.getSeconds(),"0",2);var g=(this.settings.valueToSet=="gradient"?"gradient-libraries-":"color-libraries-")+m+".txt";var o=new $msRoot.LocalFile(g);o.text=JSON.stringify(l);o.saveFile()};f.prototype.importLib=function(i){var h=document.createElement("input");h.id=this.id+"file-input";h.type="file";h.style.opacity="0";var g=new $msRoot.LocalFile();g.cbOnFileLoad=this.cbImportFile.bind(this);h.addEventListener("change",g.loadFile.bind(g),false);document.body.appendChild(h);h.click()};f.prototype.cbImportFile=function(l){var t=(this.settings.valueToSet=="gradient"?"Gradient":"Color");var q=JSON.parse(l);var k=0;var s="";if(typeof q!=="object"){alert("Invalid file format (1)");return}if(!Array.isArray(q)){alert("Invalid file format (2)");return}var m=[];for(var p=0;p<q.length;p++){if(typeof q[p]!=="object"){alert("Invalid file format (3)");return}if(q[p].nextId){k=q[p].nextId;s=q[p].type;m.push("nextId ==> "+q[p].nextId);m.push("type ==> "+q[p].type);continue}if(!q[p].value){alert("Invalid file format (5)");return}if(!q[p].value.records){alert("Invalid file format (6)");return}m.push("**** Library Name: "+q[p].id+" ****");if(q[p].value.records.length==0){m.push("Empty Library");continue}for(var o=0;o<q[p].value.records.length;o++){var g=(this.settings.valueToSet=="gradient"?"gradient":"rgbString");var h=q[p].value.records[o].name;var u=q[p].value.records[o][g];u=h+" => "+u.substr(0,50)+(u.length>50?"...":"");m.push(t+": "+u)}}if(s!==this.settings.valueToSet){alert("Only libraries of type: "+t+" may be imported.");return}var n={id:this.id,dialogTitle:"Confirm Import",text:["","The following libraries and "+t+"s will be imported:",""].concat(m).concat([""]),buttonClass:"",position:"fixed",textAlign:"left",buttonClass:"ms-gradient-button",buttonsOnTop:true,buttons:[{label:"Delete Existing",title:"Delete all existing libraries and "+t+"s before import.",cb:function(){this.doImport(q,"delete")}.bind(this)},{label:"Overwrite Duplicates",title:"Keep existing libraries and "+t+"s and overwrite duplicates from the import.",cb:function(){this.doImport(q,"overwrite")}.bind(this)},{label:"Discard Duplicates",title:"Keep existing libraries and "+t+"s and dicard duplicates from the import.",cb:function(){this.doImport(q,"discard")}.bind(this)},{label:"Cancel",title:"Cancel the import."}]};var r=new $msRoot.CustomDialog(n)};f.prototype.doImport=function(z,r){var m;var p=(this.settings.valueToSet=="gradient"?"Gradient":"Color");var u=["Import Status"];var A=new $msRoot.LocalData({key:"id",value:"value",records:"records",childKey:"name"});var n=0;var o=0;var h=0;var s=0;if(r=="delete"){A.zap(this.table)}else{s=A.getProperty(this.table,"nextId")}for(var y=0;y<z.length;y++){n=0;o=0;h=0;if(z[y].nextId){s=Math.max(s,z[y].nextId);A.setProperty(this.table,"nextId",s);u.push("Set nextId: "+s);continue}if(r!=="delete"){m=A.get(this.table,z[y].id)}if(r=="delete"||!m||!m.records||m.records.length==0){u.push("Library: "+z[y].id+" => Imported whole library - "+z[y].value.records.length+" "+p+" records.");A.set(this.table,z[y].id,z[y].value);continue}for(var x=0;x<z[y].value.records.length;x++){var l=(this.settings.valueToSet=="gradient"?"gradient":"rgbString");var g=z[y].value.records[x].name;var q=false;for(var v=0;v<m.records.length;v++){if(g==m.records[v].name){q=true;if(r=="discard"){h++}else{n++;m.records[v]=z[y].value.records[x]}break}}if(!q){o++;m.records.push(z[y].value.records[x])}}A.set(this.table,z[y].id,m);u.push("Library: "+z[y].id+" => Added: "+o+" Replaced: "+n+" Discarded: "+h)}console.log(u.join("\n"));var w=false;var t="";if(this.library){t=this.library.name}this.reset();if(t.length>0){w=this.loadLibrary({value:t})}if(!w){this.loadLibrary({value:"Default"})}};f.prototype.colorDeselect=function(){this.selectedColor=undefined;this.colorNameCombo.setValue("")};f.prototype.loadColor=function(l,g){var j,h;for(var k=0;k<this.colorSwatches.length;k++){j=decodeURIComponent(this.colorSwatches[k].getAttribute("data-name"));if(j.toLowerCase()==l.value.toLowerCase()){if(this.settings.valueToSet=="gradient"){if(this.ie9OrBelow){h=$msRoot.colorMethods.colorInfo(this.colorSwatches[k].getAttribute("data-gradient"))}else{h=$msRoot.colorMethods.colorInfo(this.colorSwatches[k].style.background)}}else{h=$msRoot.colorMethods.colorInfo(this.colorSwatches[k].style.backgroundColor)}h.name=j;this.selectColor(h,this.colorSwatches[k],g);break}}};f.prototype.libraryColorNames=function(){var h=[];if(!this.library){return}for(var g=0;g<this.library.records.length;g++){h.push(this.library.records[g].name)}return h};f.prototype.reset=function(){while(this.colorLibInner.firstChild){this.colorLibInner.removeChild(this.colorLibInner.firstChild)}this.colorSwatches=[]};f.prototype.close=function(){$msRoot.CustomDialog.closeDialogs(this.id);this.libraryNameCombo.close();this.colorNameCombo.close()};function e(){var i=[];var j=255;while(j>=0){var h="rgb("+j+","+j+","+j+")";var g=$msRoot.colorMethods.colorNameInfo(h,"name");if(!g){g=h}i.push({name:g,rgbString:h,hex:$msRoot.colorMethods.rgbToHex(h)});if(j==255){j-=31}else{j-=32}}return i}return f})();